---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabaseClient';

const { id } = Astro.params;

const { data: { session } } = await supabase.auth.getSession();
if (!session) {
    return Astro.redirect('/auth/login');
}

const { data: whisper, error: whisperError } = await supabase
    .from('whispers')
    .select('*, text_id')
    .eq('id', id)
    .single();

if (whisperError || !whisper) {
    return Astro.redirect('/posts');
}    

if (whisper.keeper_id !== session.user.id) {
    return Astro.redirect(`/posts/${whisper.text_id}`);
}

let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    const { error } = await supabase
        .from('whispers')
        .delete()
        .eq('id', id);

    if (error) throw error;

    return Astro.redirect(`/posts/${whisper.text_id}`);

  } catch (error: any) {
    errorMessage = error.message || 'Failed to erase whisper';
  }
}
---

<Layout title="ERASE WHISPER">
    <div class="max-w-2xl mx-auto">
        <a href={`/posts/${whisper.text_id}`} class="inline-flex items-center gap-2 text-neutral-light hover:text-secondary transition-colors mb-6 font-mono text-sm">
        ‚Üê BACK TO FILE</a>

        <div class="card-accent">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 animate-burn">üóëÔ∏è</div>
                <div class="font-mono text-xs text-accent mb-2">[WARNING: IRREVERSIBLE ACTION]</div>
                <h1 class="text-3xl mb-4 text-accent">ERASE THIS WHISPER?</h1>
                <p class="text-neutral-light leading-relaxed max-w-md mx-auto">
                    This action cannot be undone. Your whisper will be permanently deleted from the archive.
                </p>
            </div>
            <div class="bg-background p-4 border-l-2 border-accent mb-6">
                <div class="font-mono text-xs text-neutral mb-2">[WHISPER_PREVIEW]</div>
                <p class="text-text-muted text-sm italic">"{whisper.content}"</p>
                <p class="text-neutral-light text-xs mt-2">
                    Transmitted: {new Date(whisper.created_at).toLocaleDateString()}
                </p>
            </div>

            {errorMessage && (
                <div class="alert alert-error">
                    <span class="font-mono text-xs">[ERROR]</span> {errorMessage}
                </div>
            )}

            <div class="terminal-box mb-6 text-xs">
                <span class="text-accent">FINAL WARNING:</span>
                <span class="text-neutral-light">Once erased, this whisper cannot be recovered from the vault. Are you certain this is what you want?</span>
            </div>

            <form method="POST">
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-accent flex-1 glitch">YES, ERASE IT</button>
                    <a href={`/posts/${whisper.text_id}`} class="btn btn-ghost flex-1 text-center">PRESERVE IT</a>
                </div>
            </form>
        </div>
    </div>
</Layout>