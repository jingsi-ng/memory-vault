---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabaseClient';

const { id } = Astro.params;

const { data: { session } } = await supabase.auth.getSession();
const user = session?.user;

const { data: text, error: textError } = await supabase
  .from('preserved_texts')
  .select(`
    *,
    keeper_profiles 
    (
      keeper_name,
      assigned_book
    )
  `)
  .eq('id', id)
  .single();

if (textError || !text) {
  return Astro.redirect('/posts');
}

const { data: whispers } = await supabase
  .from('whispers')
  .select(`
    *,
    keeper_profiles (
      keeper_name
    )
  `)
  .eq('text_id', id)
  .order('whispered_at', { ascending: true });

let whisperError = '';
if (Astro.request.method === 'POST' && user) {
  try {
    const formData = await Astro.request.formData();
    const message = formData.get('message') as string;

    if (!message || message.trim().length === 0) {
      throw new Error('Message cannot be empty');
    }

    const { error } = await supabase
      .from('whispers')
      .insert([{
        text_id: parseInt(id as string),
        whisperer_id: user.id,
        message: message.trim()
      }]);

    if (error) throw error;

    return Astro.redirect(`/posts/${id}`);

  } catch (error: any) {
    whisperError = error.message;
  }
}

const isKeeper = user && text.keeper_id === user.id;

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toISOString().replace('T', ' ').substring(0, 16).replace(/-/g, '.');
}

function getBadgeClass(classification: string) {
  switch(classification?.toUpperCase()) {
    case 'DYSTOPIA': return 'badge-accent';
    case 'PHILOSOPHY': return 'badge-secondary';
    case 'CYBERPUNK': return 'badge-primary';
    case 'FORBIDDEN': return 'badge-accent';
    default: return 'badge-primary';
  }
}

const textId = id;
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || 'https://eyckvpmlfvgvlsnzrekg.supabase.co';
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Y2t2cG1sZnZndmxzbnpyZWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMjQ4OTEsImV4cCI6MjA4MTgwMDg5MX0.htPogDpA-wTHcLrg8s2b-vVoT9YsFG4ysikCqgokLck';
---

<Layout title={text.book_title}>

  <article class="max-w-4xl mx-auto">
    <a href="/posts" class="inline-flex items-center gap-2 text-neutral-light hover:text-secondary transition-colors mb-6 font-mono text-sm">
      ← BACK TO LIBRARY
    </a>

    <header class="card mb-8">
      <div class="flex flex-wrap items-start justify-between gap-4 mb-4">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="font-mono text-xs text-neutral">[FILE_{String(text.id).padStart(3, '0')}]</span>
            <span class={`badge ${getBadgeClass(text.classification)}`}>
              {text.classification || 'CLASSIFIED'}
            </span>
            <span class={`badge ${text.burn_status === 'ENDANGERED' ? 'badge-accent' : 'badge-safe'}`}>
              {text.burn_status || 'SAVED'}
            </span>
          </div>
          <h1 class="text-3xl md:text-4xl mb-2">{text.book_title}</h1>
          {text.original_author && (
            <p class="text-neutral-light">Original Author: <span class="text-secondary">{text.original_author}</span></p>
          )}
        </div>
      </div>

      <div class="flex flex-wrap gap-4 text-xs font-mono text-neutral border-t border-neutral/30 pt-4 mt-4">
        <span>Preserved: {formatDate(text.preservation_date)}</span>
        {text.last_revision && text.last_revision !== text.preservation_date && (
          <span class="text-primary">Modified: {formatDate(text.last_revision)}</span>
        )}
      </div>

      {isKeeper && (
        <div class="flex gap-3 mt-4 pt-4 border-t border-neutral/30">
          <a href={`/posts/${id}/edit`} class="btn btn-secondary text-xs">EDIT FILE</a>
          <a href={`/posts/${id}/delete`} class="btn btn-accent text-xs">DESTROY FILE</a>
        </div>
      )}
    </header>

    <div class="card-secondary mb-8">
      <div class="font-display text-xs text-neutral-light uppercase tracking-wider mb-4">
        PRESERVED TEXT FRAGMENT
      </div>
      <div class="text-text leading-relaxed font-body text-lg whitespace-pre-wrap">
        {text.text_fragment}
      </div>
    </div>

    <div class="card mb-12">
      <div class="flex items-center gap-4">
        <div class="avatar avatar-lg">
          {text.keeper_profiles?.keeper_name?.charAt(0).toUpperCase() || 'K'}
        </div>
        <div>
          <div class="text-xs text-neutral uppercase tracking-wider font-display">Memory Keeper</div>
          <div class="text-xl text-secondary font-mono">{text.keeper_profiles?.keeper_name || 'ANONYMOUS'}</div>
          {text.keeper_profiles?.assigned_book && (
            <div class="text-xs text-neutral-light mt-1">
              Assigned: {text.keeper_profiles.assigned_book}
            </div>
          )}
        </div>
      </div>
    </div>

    <section class="border-t border-neutral/30 pt-8">
      <div class="section-header">
        <span class="section-title">TRANSMISSION LOG (<span id="whisper-count">{whispers?.length || 0}</span>)</span>
  
        <div id="realtime-status" style="display:inline-flex;align-items:center;gap:6px;margin-left:12px;font:11px monospace">
          <span id="rt-dot" style="width:8px;height:8px;border-radius:50%;background:#eab308"></span>
          <span id="rt-text" style="color:#eab308">CONNECTING...</span>
        </div>
      </div>

      {user ? (
        <div class="card mb-8">
          <div class="font-display text-xs text-neutral-light uppercase tracking-wider mb-4">
            Send Transmission
          </div>
          <form method="POST">
            <div class="form-group mb-4">
              <textarea 
                id="message" 
                name="message" 
                class="form-control"
                rows="3"
                placeholder="Your signal..."
                required
              ></textarea>
            </div>
            {whisperError && (
              <p class="text-accent text-sm mb-4 font-mono">[ERROR] {whisperError}</p>
            )}
            <button type="submit" class="btn btn-secondary">
              TRANSMIT →
            </button>
          </form>
        </div>
      ) : (
        <div class="card text-center py-6 mb-8">
          <p class="text-neutral-light mb-4 font-mono text-sm">
            Authentication required to send transmissions.
          </p>
          <a href="/auth/login" class="btn btn-primary">SYSTEM ACCESS</a>
        </div>
      )}

      <div id="whispers-container" class="space-y-4">
        {whispers && whispers.length > 0 ? (
          whispers.map((whisper) => (
            <div class="card-secondary" data-whisper-id={whisper.id}>
              <div class="flex items-start gap-4">
                <div class="avatar avatar-sm flex-shrink-0">
                  {whisper.keeper_profiles?.keeper_name?.charAt(0).toUpperCase() || 'K'}
                </div>
                <div class="flex-1">
                  <div class="flex flex-wrap items-center gap-3 mb-2">
                    <span class="text-secondary font-mono text-sm">
                      {whisper.keeper_profiles?.keeper_name || 'ANONYMOUS'}
                    </span>
                    <span class="text-xs text-neutral font-mono">
                      {formatDate(whisper.whispered_at)}
                    </span>
              
                    {user && whisper.whisperer_id === user.id && (
                      <a href={`/whispers/${whisper.id}/delete`} class="text-xs text-accent hover:text-red-500 transition-colors font-mono ml-auto">
                        [ERASE]
                      </a>
                    )}            
                  </div>
                  <p class="text-text-muted leading-relaxed">{whisper.message}</p>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div id="empty-message" class="text-center py-8 text-neutral font-mono">
            <p>No transmissions received. Be the first to respond.</p>
          </div>
        )}
      </div>
    </section>
  </article>
</Layout>

<script define:vars={{ textId, supabaseUrl, supabaseKey }}>
  setTimeout(async () => {
    try {
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      const supabase = createClient(supabaseUrl, supabaseKey);

      supabase.channel('whispers-' + textId)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'whispers',
          filter: 'text_id=eq.' + textId
        }, async (payload) => {
          console.log('[451] New whisper:', payload);
          
          const { data: profile } = await supabase
            .from('keeper_profiles')
            .select('keeper_name')
            .eq('id', payload.new.whisperer_id)
            .single();

          addWhisperToPage(payload.new, profile?.keeper_name);
        })
        .subscribe((status) => {
          console.log('[451] Realtime status:', status);
          updateStatus(status === 'SUBSCRIBED');
        });

      const style = document.createElement('style');
      style.textContent = '@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}';
      document.head.appendChild(style);

    } catch (error) {
      console.error('[451] Realtime error:', error);
      updateStatus(false);
    }
  }, 1000);

  function updateStatus(connected) {
    const dot = document.getElementById('rt-dot');
    const text = document.getElementById('rt-text');
    if (connected) {
      dot.style.background = '#22c55e';
      dot.style.animation = 'pulse 2s infinite';
      text.style.color = '#22c55e';
      text.textContent = 'REALTIME ACTIVE';
    } else {
      dot.style.background = '#ef4444';
      text.style.color = '#ef4444';
      text.textContent = 'LINK FAILED';
    }
  }

  function addWhisperToPage(whisper, keeperName) {
    const container = document.getElementById('whispers-container');
    
    const emptyMsg = document.getElementById('empty-message');
    if (emptyMsg) emptyMsg.remove();

    const el = document.createElement('div');
    el.className = 'card-secondary';
    el.style.borderLeft = '3px solid #00E5FF';
    el.dataset.whisperId = whisper.id;
    
    const initial = (keeperName || 'K')[0].toUpperCase();
    const time = new Date().toISOString().slice(0, 16).replace('T', ' ').replace(/-/g, '.');
    
    el.innerHTML = `
      <div class="flex items-start gap-4">
        <div class="avatar avatar-sm flex-shrink-0">${initial}</div>
        <div class="flex-1">
          <div class="flex flex-wrap items-center gap-3 mb-2">
            <span class="text-secondary font-mono text-sm">${keeperName || 'ANONYMOUS'}</span>
            <span class="text-xs text-neutral font-mono">${time}</span>
            <span class="text-xs font-mono" style="color:#00E5FF;margin-left:auto">[NEW]</span>
          </div>
          <p class="text-text-muted leading-relaxed">${whisper.message}</p>
        </div>
      </div>
    `;

    container.appendChild(el);
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });

    const count = document.getElementById('whisper-count');
    if (count) count.textContent = parseInt(count.textContent) + 1;

    setTimeout(() => {
      el.style.borderLeft = '';
      const newTag = el.querySelector('[style*="00E5FF"]');
      if (newTag) newTag.remove();
    }, 5000);
  }
</script>