---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabaseClient';

const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect('/auth/login');
}

let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const bookTitle = formData.get('book_title') as string;
    const originalAuthor = formData.get('original_author') as string;
    const textFragment = formData.get('text_fragment') as string;
    const classification = formData.get('classification') as string;

    if (!bookTitle || !textFragment) {
      throw new Error('Title and text fragment are required');
    }

    const { data, error } = await supabase
      .from('preserved_texts')
      .insert([{
        keeper_id: session.user.id,
        book_title: bookTitle,
        original_author: originalAuthor || null,
        text_fragment: textFragment,
        classification: classification || 'CLASSIFIED',
        burn_status: 'SAVED'
      }])
      .select()
      .single();

    if (error) throw error;

    return Astro.redirect(`/posts/${data.id}`);

  } catch (error: any) {
    errorMessage = error.message || 'Failed to preserve text';
  }
}
---

<Layout title="PRESERVE A TEXT">
  <div class="max-w-3xl mx-auto">
    <div class="mb-8">
      <a href="/posts" class="inline-flex items-center gap-2 text-neutral-light hover:text-secondary transition-colors mb-4 font-mono text-sm">
        ← BACK TO LIBRARY
      </a>
      <h1 class="text-3xl md:text-4xl mb-2">PRESERVE A TEXT</h1>
      <p class="text-neutral-light font-mono text-sm">
        Upload a fragment of forbidden knowledge to the vault.
      </p>
    </div>

    {errorMessage && (
      <div class="alert alert-error">
        <span class="font-mono text-xs">[ERROR]</span> {errorMessage}
      </div>
    )}

    <div class="card" style="overflow: visible">
      <form method="POST" class="space-y-6">
        <div class="form-group">
          <label for="book_title" class="form-label">
            <span class="text-primary">›</span> BOOK TITLE <span class="text-accent">*</span>
          </label>
          <input 
            type="text" 
            id="book_title" 
            name="book_title" 
            class="form-control"
            placeholder="e.g., Fahrenheit 451"
            required
          />
        </div>

        <div class="form-group">
          <label for="original_author" class="form-label">
            <span class="text-primary">›</span> ORIGINAL AUTHOR
          </label>
          <input 
            type="text" 
            id="original_author" 
            name="original_author" 
            class="form-control"
            placeholder="e.g., Ray Bradbury"
          />
        </div>

        <div class="form-group">
          <label for="classification" class="form-label">
            <span class="text-primary">›</span> CLASSIFICATION <span class="text-accent">*</span>
          </label>
          <div class="relative" id="classification-auto">
            <input 
              type="text"
              id="classification"
              name="classification"
              class="form-control"
              placeholder="Select classification..."
              autocomplete="off"
              required
            />
            <div id="classification-dropdown" class="hidden absolute z-50 w-full mt-1 bg-background border-2 border-primary max-h-80 overflow-y-auto shadow-lg shadow-primary/20"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="text_fragment" class="form-label">
            <span class="text-primary">›</span> TEXT FRAGMENT <span class="text-accent">*</span>
          </label>
          <textarea 
            id="text_fragment" 
            name="text_fragment" 
            class="form-control"
            rows="12"
            placeholder="Enter the text you wish to preserve for future generations..."
            required
          ></textarea>
          <p class="text-xs text-neutral mt-2">
            This is your analysis, commentary, or excerpt from the work.
          </p>
        </div>

        <div class="border-t border-neutral/30 pt-6">
          <div class="terminal-box mb-6 text-xs">
            <span class="text-primary">WARNING:</span> 
            <span class="text-neutral">Once preserved, this text will be protected in the vault. 
            Only you can modify or destroy it.</span>
          </div>

          <div class="flex gap-4">
            <button type="submit" class="btn btn-primary flex-1 glitch">
              PRESERVE TEXT →
            </button>
            <a href="/posts" class="btn btn-ghost">
              CANCEL
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  const classificationSuggestions = [
    { value: 'DYSTOPIA', label: 'DYSTOPIA', subtitle: 'Anti-utopian archives' },
    { value: 'PHILOSOPHY', label: 'PHILOSOPHY', subtitle: 'Wisdom texts' },
    { value: 'CYBERPUNK', label: 'CYBERPUNK', subtitle: 'Future visions' },
    { value: 'FORBIDDEN', label: 'FORBIDDEN', subtitle: 'Banned literature' },
    { value: 'CLASSIC', label: 'CLASSIC', subtitle: 'Timeless works' },
  ];

  function initClassificationAutocomplete() {
    const input = document.getElementById('classification');
    const dropdown = document.getElementById('classification-dropdown');

    if (!input || !dropdown) return;

    function renderOptions(filter) {
      filter = filter || '';
      const filtered = filter 
        ? classificationSuggestions.filter(function(item) {
            return item.label.toLowerCase().includes(filter.toLowerCase()) ||
                   item.subtitle.toLowerCase().includes(filter.toLowerCase());
          })
        : classificationSuggestions;

      if (filtered.length === 0) {
        dropdown.classList.add('hidden');
        return;
      }

      dropdown.innerHTML = filtered.map(function(item) {
        return '<div class="classification-option px-4 py-3 cursor-pointer font-mono text-sm text-text hover:bg-primary hover:text-background border-b border-neutral/30 last:border-0 transition-colors" data-value="' + item.value + '"><span class="text-secondary mr-2"> > </span><span class="option-label">' + item.label + '</span><span class="text-neutral text-xs ml-2">- ' + item.subtitle + '</span></div>';
      }).join('');

      dropdown.classList.remove('hidden');

      dropdown.querySelectorAll('.classification-option').forEach(function(option) {
        option.addEventListener('click', function() {
          var label = option.querySelector('.option-label');
          input.value = label ? label.textContent : '';
          dropdown.classList.add('hidden');
        });
      });
    }

    input.addEventListener('focus', function() { renderOptions(input.value); });
    input.addEventListener('input', function() { renderOptions(input.value); });

    document.addEventListener('click', function(e) {
      if (!e.target.closest('#classification-auto')) {
        dropdown.classList.add('hidden');
      }
    });

    input.addEventListener('keydown', function(e) {
      const options = dropdown.querySelectorAll('.classification-option');
      const activeOption = dropdown.querySelector('.classification-option.active');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!activeOption && options[0]) {
          options[0].classList.add('active', 'bg-primary', 'text-background');
        } else if (activeOption) {
          activeOption.classList.remove('active', 'bg-primary', 'text-background');
          const next = activeOption.nextElementSibling || options[0];
          if (next) next.classList.add('active', 'bg-primary', 'text-background');
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (activeOption) {
          activeOption.classList.remove('active', 'bg-primary', 'text-background');
          const prev = activeOption.previousElementSibling || options[options.length - 1];
          if (prev) prev.classList.add('active', 'bg-primary', 'text-background');
        }
      } else if (e.key === 'Enter' && activeOption) {
        e.preventDefault();
        var label = activeOption.querySelector('.option-label');
        input.value = label ? label.textContent : '';
        dropdown.classList.add('hidden');
      } else if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', initClassificationAutocomplete);
</script>